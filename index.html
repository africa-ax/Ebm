
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Umucuruzi - Complete Trading System</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background-color: #F9FAFB;
            color: #1F2937;
        }

        .header {
            background: linear-gradient(135deg, #065F46 0%, #059669 100%);
            color: white;
            padding: 1rem 2rem;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .header-top {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }

        .header h1 {
            font-size: 1.5rem;
            font-weight: 600;
        }

        .portal-switcher {
            display: flex;
            gap: 0.5rem;
            background: rgba(255,255,255,0.1);
            padding: 0.5rem;
            border-radius: 8px;
        }

        .portal-btn {
            background: transparent;
            color: white;
            border: 2px solid transparent;
            padding: 0.5rem 1rem;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: 500;
        }

        .portal-btn.active {
            background: white;
            color: #065F46;
        }

        .btn {
            background-color: #10B981;
            color: white;
            border: none;
            padding: 0.75rem 1.5rem;
            border-radius: 8px;
            font-size: 0.95rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 2px 4px rgba(16, 185, 129, 0.2);
        }

        .btn:hover {
            background-color: #059669;
            transform: translateY(-2px);
        }

        .btn-secondary { background-color: #059669; }
        .btn-small { padding: 0.5rem 1rem; font-size: 0.875rem; }
        .btn-reject { background-color: #EF4444; }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 2rem;
        }

        .auth-container {
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            background: linear-gradient(135deg, #065F46 0%, #10B981 100%);
        }

        .auth-box {
            background: white;
            padding: 3rem;
            border-radius: 16px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            width: 100%;
            max-width: 450px;
        }

        .form-group {
            margin-bottom: 1.5rem;
        }

        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 500;
            color: #374151;
        }

        .form-group input, .form-group select {
            width: 100%;
            padding: 0.875rem;
            border: 2px solid #E5E7EB;
            border-radius: 8px;
            font-size: 1rem;
        }

        .form-group input:focus, .form-group select:focus {
            outline: none;
            border-color: #10B981;
        }

        .link-text {
            color: #10B981;
            cursor: pointer;
            font-weight: 600;
            text-decoration: none;
        }

        .link-text:hover {
            text-decoration: underline;
        }

        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 2rem;
            margin-top: 2rem;
        }

        .card {
            background: white;
            border-radius: 12px;
            padding: 1.5rem;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
            padding-bottom: 1rem;
            border-bottom: 2px solid #F3F4F6;
        }

        .card-header h3 {
            color: #065F46;
            font-size: 1.25rem;
        }

        .badge {
            background-color: #10B981;
            color: white;
            padding: 0.25rem 0.75rem;
            border-radius: 12px;
            font-size: 0.875rem;
            font-weight: 600;
        }

        .badge-warning { background-color: #F59E0B; }
        .badge-error { background-color: #EF4444; }
        .badge-blue { background-color: #3B82F6; }

        .stat-card {
            background: linear-gradient(135deg, #10B981 0%, #059669 100%);
            color: white;
            padding: 1.5rem;
            border-radius: 12px;
            text-align: center;
        }

        .stat-value {
            font-size: 2rem;
            font-weight: 700;
            margin: 0.5rem 0;
        }

        .cart-floating {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: linear-gradient(135deg, #10B981 0%, #059669 100%);
            color: white;
            padding: 1rem 1.5rem;
            border-radius: 50px;
            box-shadow: 0 4px 20px rgba(16, 185, 129, 0.4);
            cursor: pointer;
            transition: all 0.3s;
            z-index: 100;
        }

        .cart-floating:hover {
            transform: scale(1.05);
            box-shadow: 0 6px 30px rgba(16, 185, 129, 0.6);
        }

        .cart-badge {
            position: absolute;
            top: -8px;
            right: -8px;
            background: #EF4444;
            color: white;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.75rem;
            font-weight: 700;
        }

        .broadcast-control {
            background: linear-gradient(135deg, #10B981 0%, #059669 100%);
            color: white;
            padding: 1.5rem;
            border-radius: 12px;
            text-align: center;
            margin-bottom: 2rem;
        }

        .broadcast-toggle {
            background: white;
            color: #065F46;
            border: none;
            padding: 1rem 2rem;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            margin-top: 1rem;
            transition: all 0.3s;
        }

        .broadcast-toggle:hover {
            transform: scale(1.05);
        }

        .broadcast-toggle.broadcasting {
            background: #FEF3C7;
            color: #92400E;
        }

        .stock-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 1rem;
        }

        .stock-table th {
            background-color: #F3F4F6;
            padding: 1rem;
            text-align: left;
            font-weight: 600;
        }

        .stock-table td {
            padding: 1rem;
            border-bottom: 1px solid #E5E7EB;
        }

        .stock-status {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 0.5rem;
        }

        .stock-ok { background-color: #10B981; }
        .stock-low { background-color: #F59E0B; }
        .stock-out { background-color: #EF4444; }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            z-index: 999;
            align-items: center;
            justify-content: center;
        }

        .modal.active { display: flex; }

        .modal-content {
            background: white;
            padding: 2rem;
            border-radius: 16px;
            max-width: 700px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
        }

        .toast {
            position: fixed;
            top: 20px;
            right: 20px;
            background-color: #10B981;
            color: white;
            padding: 1rem 1.5rem;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            z-index: 1000;
            animation: slideIn 0.3s ease;
        }

        .toast.error { background-color: #EF4444; }

        @keyframes slideIn {
            from { transform: translateX(400px); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        .hidden { display: none !important; }

        .seller-card {
            border: 2px solid #E5E7EB;
            border-radius: 12px;
            padding: 1.5rem;
            margin-bottom: 1rem;
            cursor: pointer;
            transition: all 0.3s;
        }

        .seller-card:hover {
            border-color: #10B981;
            box-shadow: 0 4px 12px rgba(16, 185, 129, 0.2);
        }

        .order-item {
            background: #F9FAFB;
            padding: 1rem;
            border-radius: 8px;
            margin-bottom: 1rem;
        }

        .cart-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem;
            background: #F9FAFB;
            border-radius: 8px;
            margin-bottom: 0.5rem;
        }

        @media (max-width: 768px) {
            .dashboard-grid { grid-template-columns: 1fr; }
            .container { padding: 1rem; }
            .cart-floating { bottom: 80px; }
        }
    </style>
</head>
<body>
    <!-- Auth Page -->
    <div id="authPage" class="auth-container">
        <div class="auth-box">
            <h2 style="color: #065F46; text-align: center; margin-bottom: 2rem;">üè™ Umucuruzi</h2>
            
            <!-- Login Form -->
            <div id="loginForm">
                <div class="form-group">
                    <label>TIN Number</label>
                    <input type="text" id="loginTin" placeholder="Enter your TIN">
                </div>
                <div class="form-group">
                    <label>Password</label>
                    <input type="password" id="loginPassword" placeholder="Password">
                </div>
                <button class="btn" style="width: 100%;" onclick="handleLogin()">Login</button>
                <div style="text-align: center; margin-top: 1rem;">
                    <span class="link-text" onclick="showForgotPassword()">Forgot Password?</span>
                </div>
                <div style="text-align: center; margin-top: 1rem; color: #6B7280;">
                    Don't have an account? <span class="link-text" onclick="showSignup()">Sign Up</span>
                </div>
            </div>

            <!-- Signup Form -->
            <div id="signupForm" class="hidden">
                <div class="form-group">
                    <label>Business Name</label>
                    <input type="text" id="signupBusiness" placeholder="Your business name">
                </div>
                <div class="form-group">
                    <label>TIN Number</label>
                    <input type="text" id="signupTin" placeholder="TIN number">
                </div>
                <div class="form-group">
                    <label>Email</label>
                    <input type="email" id="signupEmail" placeholder="email@example.com">
                </div>
                <div class="form-group">
                    <label>Password</label>
                    <input type="password" id="signupPassword" placeholder="Create password">
                </div>
                <div class="form-group">
                    <label>Confirm Password</label>
                    <input type="password" id="signupConfirmPassword" placeholder="Confirm password">
                </div>
                <button class="btn" style="width: 100%;" onclick="handleSignup()">Sign Up</button>
                <div style="text-align: center; margin-top: 1.5rem; color: #6B7280;">
                    Already have an account? <span class="link-text" onclick="showLogin()">Login</span>
                </div>
            </div>

            <!-- Forgot Password Form -->
            <div id="forgotPasswordForm" class="hidden">
                <div class="form-group">
                    <label>TIN Number</label>
                    <input type="text" id="resetTin" placeholder="Enter your TIN">
                </div>
                <div class="form-group">
                    <label>Email</label>
                    <input type="email" id="resetEmail" placeholder="Enter your email">
                </div>
                <button class="btn" style="width: 100%;" onclick="handleForgotPassword()">Reset Password</button>
                <div style="text-align: center; margin-top: 1.5rem; color: #6B7280;">
                    Remember your password? <span class="link-text" onclick="showLogin()">Login</span>
                </div>
            </div>

            <!-- Set New Password Form -->
            <div id="newPasswordForm" class="hidden">
                <div class="form-group">
                    <label>New Password</label>
                    <input type="password" id="newPassword" placeholder="Enter new password">
                </div>
                <div class="form-group">
                    <label>Confirm New Password</label>
                    <input type="password" id="confirmNewPassword" placeholder="Confirm new password">
                </div>
                <button class="btn" style="width: 100%;" onclick="handleSetNewPassword()">Set New Password</button>
            </div>
        </div>
    </div>

    <!-- Main Dashboard -->
    <div id="mainDashboard" class="hidden">
        <div class="header">
            <div class="header-top">
                <h1>üè™ Umucuruzi</h1>
                <div style="display: flex; gap: 1rem; align-items: center;">
                    <span id="userName">Welcome!</span>
                    <button class="btn btn-secondary btn-small" onclick="handleLogout()">Logout</button>
                </div>
            </div>
            <div class="portal-switcher">
                <button class="portal-btn active" id="buyBtn" onclick="switchPortal('buy')">üõí Buy</button>
                <button class="portal-btn" id="sellBtn" onclick="switchPortal('sell')">üì¶ Sell</button>
                <button class="portal-btn" id="stockBtn" onclick="switchPortal('stock')">üìä Stock</button>
            </div>
        </div>

        <!-- Floating Cart Button -->
        <div id="cartFloating" class="cart-floating hidden" onclick="showCart()">
            <span style="font-size: 1.5rem;">üõí</span>
            <span style="margin-left: 0.5rem; font-weight: 600;">Cart</span>
            <span class="cart-badge" id="cartBadge">0</span>
        </div>

        <!-- Buy Portal -->
        <div id="buyPortal" class="container">
            <div class="card" style="margin-bottom: 2rem;">
                <div style="display: flex; gap: 1rem; align-items: center;">
                    <input type="text" id="searchInput" placeholder="üîç Search products, sellers, categories..." 
                           style="flex: 1; padding: 0.875rem; border: 2px solid #E5E7EB; border-radius: 8px; font-size: 1rem;">
                    <button class="btn" onclick="performSearch()">Search</button>
                    <button class="btn btn-secondary" onclick="clearSearch()">Clear</button>
                </div>
                <div id="searchResults" style="margin-top: 1rem;"></div>
            </div>

            <div class="card">
                <div class="card-header">
                    <h3>üì° Available Sellers</h3>
                    <button class="btn btn-small" onclick="scanForSellers()">üîç Scan</button>
                </div>
                <div id="sellersList"></div>
            </div>

            <div id="selectedSellerProducts" class="hidden">
                <div class="card" style="margin-top: 2rem;">
                    <div class="card-header">
                        <h3>Products from <span id="selectedSellerName"></span></h3>
                        <button class="btn btn-small" onclick="closeSellerProducts()">‚Üê Back</button>
                    </div>
                    <div id="sellerProductList"></div>
                </div>
            </div>

            <div class="card" style="margin-top: 2rem;">
                <div class="card-header">
                    <h3>üìÑ My Invoices</h3>
                    <span class="badge" id="invoiceCount">0</span>
                </div>
                <div id="myInvoices"></div>
            </div>
        </div>

        <!-- Sell Portal -->
        <div id="sellPortal" class="container hidden">
            <div class="broadcast-control">
                <h3 style="margin-bottom: 0.5rem;">üì° Broadcast Status</h3>
                <p style="margin: 0.5rem 0;">Your TIN: <strong id="broadcastTin"></strong></p>
                <p style="font-size: 0.875rem; opacity: 0.9; margin-bottom: 1rem;" id="broadcastStatus">
                    Not broadcasting - Buyers cannot see your products
                </p>
                <button class="broadcast-toggle" id="broadcastBtn" onclick="toggleBroadcast()">
                    üî¥ Start Broadcasting
                </button>
            </div>

            <div class="card">
                <div class="card-header">
                    <h3>üõí Pending Orders</h3>
                    <span class="badge badge-warning" id="pendingOrderCount">0</span>
                </div>
                <div id="pendingOrders"></div>
            </div>

            <div class="card" style="margin-top: 2rem;">
                <div class="card-header">
                    <h3>‚úÖ Approved Orders</h3>
                </div>
                <div id="approvedOrders"></div>
            </div>
        </div>

        <!-- Stock Portal -->
        <div id="stockPortal" class="container hidden">
            <div class="dashboard-grid">
                <div class="stat-card">
                    <div>üì¶ Total Products</div>
                    <div class="stat-value" id="statTotalProducts">0</div>
                </div>
                <div class="stat-card">
                    <div>üí∞ Total Stock Value</div>
                    <div class="stat-value" id="statStockValue">0 RWF</div>
                </div>
                <div class="stat-card">
                    <div>üìà Today's Profit</div>
                    <div class="stat-value" id="statTodayProfit">0 RWF</div>
                </div>
                <div class="stat-card">
                    <div>üìä Monthly Profit</div>
                    <div class="stat-value" id="statMonthProfit">0 RWF</div>
                </div>
            </div>

            <div class="dashboard-grid" style="margin-top: 2rem;">
                <div class="card">
                    <div class="card-header">
                        <h3>‚ûï Stock In</h3>
                    </div>
                    <div class="form-group">
                        <label>Product Name</label>
                        <input type="text" id="stockInName" placeholder="e.g., Milk 1L">
                    </div>
                    <div class="form-group">
                        <label>Category</label>
                        <select id="stockInCategory">
                            <option value="beverages">Beverages</option>
                            <option value="food">Food</option>
                            <option value="electronics">Electronics</option>
                            <option value="supplies">Supplies</option>
                            <option value="other">Other</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Quantity</label>
                        <input type="number" id="stockInQuantity" placeholder="0" min="1">
                    </div>
                    <div class="form-group">
                        <label>Buying Price</label>
                        <input type="number" id="stockInBuyPrice" placeholder="0" min="0">
                    </div>
                    <div class="form-group">
                        <label>Selling Price</label>
                        <input type="number" id="stockInSellPrice" placeholder="0" min="0">
                    </div>
                    <div class="form-group">
                        <label>Tax Type</label>
                        <select id="stockInTax">
                            <option value="taxable">Taxable (18% VAT)</option>
                            <option value="exempt">Tax Exempt</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Supplier</label>
                        <input type="text" id="stockInSupplier" placeholder="Supplier name">
                    </div>
                    <button class="btn" onclick="addStockIn()" style="width: 100%;">Add to Stock</button>
                </div>

                <div class="card">
                    <div class="card-header">
                        <h3>‚ûñ Stock Out</h3>
                    </div>
                    <div class="form-group">
                        <label>Select Product</label>
                        <select id="stockOutProduct" onchange="updateStockOutInfo()">
                            <option value="">-- Choose Product --</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Quantity to Sell</label>
                        <input type="number" id="stockOutQuantity" placeholder="0" min="1">
                    </div>
                    <div id="stockOutInfo" style="padding: 1rem; background: #F3F4F6; border-radius: 8px; margin-bottom: 1rem; font-size: 0.875rem;"></div>
                    <button class="btn" onclick="addStockOut()" style="width: 100%;">Record Sale</button>
                </div>
            </div>

            <div class="card" style="margin-top: 2rem;">
                <div class="card-header">
                    <h3>üìã Inventory</h3>
                    <button class="btn btn-small" onclick="refreshInventory()">üîÑ Refresh</button>
                </div>
                <div style="overflow-x: auto;">
                    <table class="stock-table">
                        <thead>
                            <tr>
                                <th>Status</th>
                                <th>Product</th>
                                <th>Category</th>
                                <th>In Stock</th>
                                <th>Buy Price</th>
                                <th>Sell Price</th>
                                <th>Profit Margin</th>
                                <th>Stock Value</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="inventoryTable"></tbody>
                    </table>
                </div>
            </div>

            <div class="card" style="margin-top: 2rem;">
                <div class="card-header">
                    <h3>üìä Reports</h3>
                    <div style="display: flex; gap: 0.5rem;">
                        <button class="btn btn-small" onclick="generateReport('daily')">Daily</button>
                        <button class="btn btn-small" onclick="generateReport('weekly')">Weekly</button>
                        <button class="btn btn-small" onclick="generateReport('monthly')">Monthly</button>
                        <button class="btn btn-secondary btn-small" onclick="exportReport()">üì• Export CSV</button>
                    </div>
                </div>
                <div id="reportContent"></div>
            </div>
        </div>
    </div>

    <!-- Cart Modal -->
    <div id="cartModal" class="modal">
        <div class="modal-content">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem; padding-bottom: 1rem; border-bottom: 2px solid #E5E7EB;">
                <h3>üõí Shopping Cart</h3>
                <button onclick="closeCart()" style="background: none; border: none; font-size: 1.5rem; cursor: pointer;">√ó</button>
            </div>
            <div id="cartItemsContainer"></div>
            <div style="margin-top: 2rem; padding-top: 1rem; border-top: 2px solid #E5E7EB;">
                <div style="display: grid; grid-template-columns: 1fr auto; gap: 0.5rem; margin-bottom: 1rem;">
                    <div>Subtotal:</div>
                    <div style="font-weight: 600;" id="cartSubtotal">0 RWF</div>
                    <div>Tax (18%):</div>
                    <div style="font-weight: 600;" id="cartTax">0 RWF</div>
                    <div style="font-size: 1.25rem; padding-top: 0.5rem; border-top: 1px solid #E5E7EB;">Total:</div>
                    <div style="font-size: 1.25rem; font-weight: 700; color: #10B981; padding-top: 0.5rem; border-top: 1px solid #E5E7EB;" id="cartTotal">0 RWF</div>
                </div>
                <button class="btn" onclick="checkout()" style="width: 100%;">Place Order</button>
            </div>
        </div>
    </div>

    <!-- Invoice Modal -->
    <div id="invoiceModal" class="modal">
        <div class="modal-content">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem; padding-bottom: 1rem; border-bottom: 2px solid #E5E7EB;">
                <h3>üìÑ Invoice</h3>
                <button onclick="closeInvoice()" style="background: none; border: none; font-size: 1.5rem; cursor: pointer;">√ó</button>
            </div>
            <div id="invoiceContent"></div>
        </div>
    </div>

    <script>
        // ==================== STATE ====================
        let currentUser = null;
        let currentPortal = 'buy';
        let isBroadcasting = false;
        let cart = [];
        let inventory = [];
        let sales = [];
        let orders = [];
        let broadcasts = [];
        let resetUserData = null;

        // ==================== INITIALIZATION ====================
        function init() {
            loadDemoData();
            checkAuth();
        }

        function loadDemoData() {
            // Load demo inventory
            const demoInventory = [
                { productId: 'p1', name: 'Milk 1L', category: 'beverages', quantity: 50, buyPrice: 800, sellPrice: 1000, taxType: 'taxable', supplier: 'Inyange' },
                { productId: 'p2', name: 'Bread', category: 'food', quantity: 30, buyPrice: 500, sellPrice: 700, taxType: 'taxable', supplier: 'Hot Loaf' },
                { productId: 'p3', name: 'Rice 1kg', category: 'food', quantity: 100, buyPrice: 1200, sellPrice: 1500, taxType: 'taxable', supplier: 'Import Co' }
            ];
            inventory = JSON.parse(localStorage.getItem('inventory')) || demoInventory;
            
            // Load demo users
            if (!localStorage.getItem('users')) {
                localStorage.setItem('users', JSON.stringify([
                    { tin: '123456789', business: 'Demo Store', email: 'demo@store.com', password: 'demo123' }
                ]));
            }
        }

        function checkAuth() {
            currentUser = JSON.parse(localStorage.getItem('currentUser'));
            if (currentUser) {
                showDashboard();
            }
        }

        // ==================== AUTH FUNCTIONS ====================
        function showLogin() {
            document.getElementById('loginForm').classList.remove('hidden');
            document.getElementById('signupForm').classList.add('hidden');
            document.getElementById('forgotPasswordForm').classList.add('hidden');
            document.getElementById('newPasswordForm').classList.add('hidden');
        }

        function showSignup() {
            document.getElementById('loginForm').classList.add('hidden');
            document.getElementById('signupForm').classList.remove('hidden');
            document.getElementById('forgotPasswordForm').classList.add('hidden');
            document.getElementById('newPasswordForm').classList.add('hidden');
        }

        function showForgotPassword() {
            document.getElementById('loginForm').classList.add('hidden');
            document.getElementById('signupForm').classList.add('hidden');
            document.getElementById('forgotPasswordForm').classList.remove('hidden');
            document.getElementById('newPasswordForm').classList.add('hidden');
        }

        function handleLogin() {
            const tin = document.getElementById('loginTin').value;
            const password = document.getElementById('loginPassword').value;
            
            if (!tin || !password) {
                showToast('Please enter TIN and password', 'error');
                return;
            }
            
            const users = JSON.parse(localStorage.getItem('users')) || [];
            const user = users.find(u => u.tin === tin && u.password === password);
            
            if (user) {
                currentUser = user;
                localStorage.setItem('currentUser', JSON.stringify(user));
                showDashboard();
                showToast('Login successful!');
            } else {
                showToast('Invalid TIN or password', 'error');
            }
        }

        function handleSignup() {
            const business = document.getElementById('signupBusiness').value;
            const tin = document.getElementById('signupTin').value;
            const email = document.getElementById('signupEmail').value;
            const password = document.getElementById('signupPassword').value;
            const confirmPassword = document.getElementById('signupConfirmPassword').value;
            
            if (!business || !tin || !email || !password || !confirmPassword) {
                showToast('Please fill all fields', 'error');
                return;
            }
            
            if (password !== confirmPassword) {
                showToast('Passwords do not match', 'error');
                return;
            }
            
            const users = JSON.parse(localStorage.getItem('users')) || [];
            
            if (users.find(u => u.tin === tin)) {
                showToast('TIN already registered', 'error');
                return;
            }
            
            const newUser = { business, tin, email, password };
            users.push(newUser);
            localStorage.setItem('users', JSON.stringify(users));
            
            showToast('Registration successful! Please login.');
            showLogin();
        }

        function handleForgotPassword() {
            const tin = document.getElementById('resetTin').value;
            const email = document.getElementById('resetEmail').value;
            
            if (!tin || !email) {
                showToast('Please enter TIN and email', 'error');
                return;
            }
            
            const users = JSON.parse(localStorage.getItem('users')) || [];
            const user = users.find(u => u.tin === tin && u.email === email);
            
            if (user) {
                resetUserData = user;
                document.getElementById('forgotPasswordForm').classList.add('hidden');
                document.getElementById('newPasswordForm').classList.remove('hidden');
                showToast('Please set new password');
            } else {
                showToast('TIN and email combination not found', 'error');
            }
        }

        function handleSetNewPassword() {
            const newPassword = document.getElementById('newPassword').value;
            const confirmNewPassword = document.getElementById('confirmNewPassword').value;
            
            if (!newPassword || !confirmNewPassword) {
                showToast('Please enter new password', 'error');
                return;
            }
            
            if (newPassword !== confirmNewPassword) {
                showToast('Passwords do not match', 'error');
                return;
            }
            
            const users = JSON.parse(localStorage.getItem('users')) || [];
            const userIndex = users.findIndex(u => u.tin === resetUserData.tin);
            
            if (userIndex !== -1) {
                users[userIndex].password = newPassword;
                localStorage.setItem('users', JSON.stringify(users));
                showToast('Password reset successful! Please login.');
                showLogin();
            }
        }

        function handleLogout() {
            currentUser = null;
            localStorage.removeItem('currentUser');
            localStorage.removeItem('sellerOrders');
            document.getElementById('mainDashboard').classList.add('hidden');
            document.getElementById('authPage').classList.remove('hidden');
            showToast('Logged out successfully');
        }

        function showDashboard() {
            document.getElementById('authPage').classList.add('hidden');
            document.getElementById('mainDashboard').classList.remove('hidden');
            document.getElementById('userName').textContent = `Welcome, ${currentUser.business}!`;
            document.getElementById('broadcastTin').textContent = currentUser.tin;
            
            refreshInventory();
            updateCartBadge();
            loadInvoices();
            loadDemoSellerOrders();
            updateStats();
        }

        // ==================== PORTAL SWITCHING ====================
        function switchPortal(portal) {
            currentPortal = portal;
            
            // Update active button
            document.getElementById('buyBtn').classList.remove('active');
            document.getElementById('sellBtn').classList.remove('active');
            document.getElementById('stockBtn').classList.remove('active');
            document.getElementById(portal + 'Btn').classList.add('active');
            
            // Show/hide portals
            document.getElementById('buyPortal').classList.add('hidden');
            document.getElementById('sellPortal').classList.add('hidden');
            document.getElementById('stockPortal').classList.add('hidden');
            document.getElementById(portal + 'Portal').classList.remove('hidden');
            
            // Show/hide cart floating button
            if (portal === 'buy') {
                document.getElementById('cartFloating').classList.remove('hidden');
            } else {
                document.getElementById('cartFloating').classList.add('hidden');
            }
        }

        // ==================== BUY PORTAL FUNCTIONS ====================
        function scanForSellers() {
            showToast('Scanning for nearby sellers...');
            // Simulate finding sellers
            setTimeout(() => {
                const sellers = [
                    { name: 'City Market', tin: '987654321', distance: '0.5km' },
                    { name: 'Quick Mart', tin: '456123789', distance: '1.2km' },
                    { name: 'Super Store', tin: '789456123', distance: '0.8km' }
                ];
                
                const sellersList = document.getElementById('sellersList');
                sellersList.innerHTML = '';
                
                sellers.forEach(seller => {
                    const sellerCard = document.createElement('div');
                    sellerCard.className = 'seller-card';
                    sellerCard.innerHTML = `
                        <h4>${seller.name}</h4>
                        <p>TIN: ${seller.tin} ‚Ä¢ ${seller.distance} away</p>
                    `;
                    sellerCard.onclick = () => selectSeller(seller);
                    sellersList.appendChild(sellerCard);
                });
                
                showToast(`Found ${sellers.length} sellers nearby`);
            }, 2000);
        }

        function selectSeller(seller) {
            document.getElementById('selectedSellerName').textContent = seller.name;
            document.getElementById('selectedSellerProducts').classList.remove('hidden');
            
            // Simulate loading seller products
            const products = [
                { productId: 'sp1', name: 'Coca Cola 500ml', price: 600, quantity: 20 },
                { productId: 'sp2', name: 'Chips', price: 800, quantity: 15 },
                { productId: 'sp3', name: 'Bottled Water', price: 300, quantity: 30 }
            ];
            
            const productList = document.getElementById('sellerProductList');
            productList.innerHTML = '';
            
            products.forEach(product => {
                const productDiv = document.createElement('div');
                productDiv.className = 'cart-item';
                productDiv.innerHTML = `
                    <div>
                        <strong>${product.name}</strong>
                        <div>${product.price} RWF ‚Ä¢ ${product.quantity} in stock</div>
                    </div>
                    <button class="btn btn-small" onclick="addToCart('${product.productId}', '${product.name}', ${product.price})">Add to Cart</button>
                `;
                productList.appendChild(productDiv);
            });
        }

        function closeSellerProducts() {
            document.getElementById('selectedSellerProducts').classList.add('hidden');
        }

        function performSearch() {
            const query = document.getElementById('searchInput').value.toLowerCase();
            if (!query) {
                showToast('Please enter search term', 'error');
                return;
            }
            
            // Simulate search results
            const results = [
                { type: 'product', name: 'Milk 1L', seller: 'City Market', price: 1000 },
                { type: 'seller', name: 'City Market', description: 'Groceries and beverages' },
                { type: 'category', name: 'Beverages', count: '15 products' }
            ];
            
            const resultsDiv = document.getElementById('searchResults');
            resultsDiv.innerHTML = '<h4>Search Results:</h4>';
            
            results.forEach(result => {
                const resultDiv = document.createElement('div');
                resultDiv.className = 'cart-item';
                resultDiv.innerHTML = `
                    <div>
                        <strong>${result.name}</strong>
                        <div>${result.type} ‚Ä¢ ${result.seller || result.description || result.count}</div>
                    </div>
                    ${result.price ? `<div>${result.price} RWF</div>` : ''}
                `;
                resultsDiv.appendChild(resultDiv);
            });
        }

        function clearSearch() {
            document.getElementById('searchInput').value = '';
            document.getElementById('searchResults').innerHTML = '';
        }

        // ==================== CART FUNCTIONS ====================
        function addToCart(productId, productName, price) {
            const existingItem = cart.find(item => item.productId === productId);
            
            if (existingItem) {
                existingItem.quantity += 1;
            } else {
                cart.push({
                    productId,
                    name: productName,
                    price,
                    quantity: 1
                });
            }
            
            updateCartBadge();
            showToast(`${productName} added to cart`);
        }

        function updateCartBadge() {
            const totalItems = cart.reduce((sum, item) => sum + item.quantity, 0);
            document.getElementById('cartBadge').textContent = totalItems;
        }

        function showCart() {
            const modal = document.getElementById('cartModal');
            const container = document.getElementById('cartItemsContainer');
            
            container.innerHTML = '';
            
            if (cart.length === 0) {
                container.innerHTML = '<p>Your cart is empty</p>';
            } else {
                cart.forEach((item, index) => {
                    const itemDiv = document.createElement('div');
                    itemDiv.className = 'cart-item';
                    itemDiv.innerHTML = `
                        <div>
                            <strong>${item.name}</strong>
                            <div>${item.price} RWF √ó ${item.quantity}</div>
                        </div>
                        <div style="display: flex; align-items: center; gap: 0.5rem;">
                            <button class="btn btn-small" onclick="updateCartQuantity(${index}, -1)">-</button>
                            <span>${item.quantity}</span>
                            <button class="btn btn-small" onclick="updateCartQuantity(${index}, 1)">+</button>
                            <button class="btn btn-small btn-reject" onclick="removeFromCart(${index})">√ó</button>
                        </div>
                    `;
                    container.appendChild(itemDiv);
                });
            }
            
            updateCartTotals();
            modal.classList.add('active');
        }

        function updateCartQuantity(index, change) {
            cart[index].quantity += change;
            
            if (cart[index].quantity <= 0) {
                cart.splice(index, 1);
            }
            
            updateCartBadge();
            showCart(); // Refresh cart display
        }

        function removeFromCart(index) {
            cart.splice(index, 1);
            updateCartBadge();
            showCart(); // Refresh cart display
        }

        function updateCartTotals() {
            const subtotal = cart.reduce((sum, item) => sum + (item.price * item.quantity), 0);
            const tax = subtotal * 0.18; // 18% VAT
            const total = subtotal + tax;
            
            document.getElementById('cartSubtotal').textContent = `${subtotal.toLocaleString()} RWF`;
            document.getElementById('cartTax').textContent = `${tax.toLocaleString()} RWF`;
            document.getElementById('cartTotal').textContent = `${total.toLocaleString()} RWF`;
        }

        function closeCart() {
            document.getElementById('cartModal').classList.remove('active');
        }

        function checkout() {
            if (cart.length === 0) {
                showToast('Cart is empty', 'error');
                return;
            }
            
            // Create invoice
            const invoice = {
                id: 'INV-' + Date.now(),
                date: new Date().toISOString(),
                items: [...cart],
                subtotal: cart.reduce((sum, item) => sum + (item.price * item.quantity), 0),
                tax: 0,
                total: 0
            };
            
            invoice.tax = invoice.subtotal * 0.18;
            invoice.total = invoice.subtotal + invoice.tax;
            
            // Save invoice
            const invoices = JSON.parse(localStorage.getItem('invoices')) || [];
            invoices.push(invoice);
            localStorage.setItem('invoices', JSON.stringify(invoices));
            
            // üî• NEW FEATURE: Automatic buyer stock update and zero-stock removal
            updateBuyerStockAfterPurchase(invoice.items);
            
            // Clear cart
            cart = [];
            updateCartBadge();
            closeCart();
            
            // Show invoice
            showInvoice(invoice);
            showToast('Order placed successfully!');
            
            // Refresh invoices list
            loadInvoices();
        }

        // üî• NEW FEATURE: Automatic buyer stock update and zero-stock removal
        function updateBuyerStockAfterPurchase(purchasedItems) {
            purchasedItems.forEach(purchasedItem => {
                const existingProduct = inventory.find(item => 
                    item.name === purchasedItem.name && item.sellPrice === purchasedItem.price
                );
                
                if (existingProduct) {
                    // Update existing product quantity
                    existingProduct.quantity += purchasedItem.quantity;
                } else {
                    // Add new product to inventory
                    inventory.push({
                        productId: 'p' + Date.now(),
                        name: purchasedItem.name,
                        category: 'other',
                        quantity: purchasedItem.quantity,
                        buyPrice: purchasedItem.price * 0.8, // Estimate buy price
                        sellPrice: purchasedItem.price,
                        taxType: 'taxable',
                        supplier: 'Purchase'
                    });
                }
            });
            
            // Remove zero-quantity items
            inventory = inventory.filter(item => item.quantity > 0);
            
            // Save updated inventory
            localStorage.setItem('inventory', JSON.stringify(inventory));
            
            // Refresh display
            refreshInventory();
        }

        function showInvoice(invoice) {
            const modal = document.getElementById('invoiceModal');
            const content = document.getElementById('invoiceContent');
            
            content.innerHTML = `
                <div style="margin-bottom: 1rem;">
                    <strong>Invoice ID:</strong> ${invoice.id}<br>
                    <strong>Date:</strong> ${new Date(invoice.date).toLocaleString()}
                </div>
                <div style="margin-bottom: 1rem;">
                    ${invoice.items.map(item => `
                        <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem;">
                            <span>${item.name} √ó ${item.quantity}</span>
                            <span>${(item.price * item.quantity).toLocaleString()} RWF</span>
                        </div>
                    `).join('')}
                </div>
                <div style="border-top: 1px solid #E5E7EB; padding-top: 0.5rem;">
                    <div style="display: flex; justify-content: space-between;">
                        <span>Subtotal:</span>
                        <span>${invoice.subtotal.toLocaleString()} RWF</span>
                    </div>
                    <div style="display: flex; justify-content: space-between;">
                        <span>Tax (18%):</span>
                        <span>${invoice.tax.toLocaleString()} RWF</span>
                    </div>
                    <div style="display: flex; justify-content: space-between; font-weight: bold; font-size: 1.1rem; margin-top: 0.5rem;">
                        <span>Total:</span>
                        <span>${invoice.total.toLocaleString()} RWF</span>
                    </div>
                </div>
                <div style="margin-top: 1.5rem; text-align: center;">
                    <button class="btn" onclick="printInvoice()">Print Invoice</button>
                </div>
            `;
            
            modal.classList.add('active');
        }

        function closeInvoice() {
            document.getElementById('invoiceModal').classList.remove('active');
        }

        function printInvoice() {
            window.print();
        }

        function loadInvoices() {
            const invoices = JSON.parse(localStorage.getItem('invoices')) || [];
            const container = document.getElementById('myInvoices');
            
            document.getElementById('invoiceCount').textContent = invoices.length;
            
            if (invoices.length === 0) {
                container.innerHTML = '<p>No invoices yet</p>';
                return;
            }
            
            container.innerHTML = '';
            invoices.slice(-5).reverse().forEach(invoice => {
                const invoiceDiv = document.createElement('div');
                invoiceDiv.className = 'order-item';
                invoiceDiv.innerHTML = `
                    <div style="display: flex; justify-content: space-between;">
                        <div>
                            <strong>${invoice.id}</strong>
                            <div>${new Date(invoice.date).toLocaleDateString()}</div>
                        </div>
                        <div style="text-align: right;">
                            <div>${invoice.total.toLocaleString()} RWF</div>
                            <button class="btn btn-small" onclick="showInvoice(${JSON.stringify(invoice).replace(/"/g, '&quot;')})">View</button>
                        </div>
                    </div>
                `;
                container.appendChild(invoiceDiv);
            });
        }

        // ==================== SELL PORTAL FUNCTIONS ====================
        function toggleBroadcast() {
            isBroadcasting = !isBroadcasting;
            const btn = document.getElementById('broadcastBtn');
            const status = document.getElementById('broadcastStatus');
            
            if (isBroadcasting) {
                btn.textContent = 'üü¢ Stop Broadcasting';
                btn.classList.add('broadcasting');
                status.textContent = 'Broadcasting - Buyers can see your products';
                showToast('Now broadcasting to buyers');
            } else {
                btn.textContent = 'üî¥ Start Broadcasting';
                btn.classList.remove('broadcasting');
                status.textContent = 'Not broadcasting - Buyers cannot see your products';
                showToast('Stopped broadcasting');
            }
        }

        function loadOrders() {
            // Simulate loading orders
            const pendingOrders = [
                { id: 'ORD-001', customer: 'City Buyer', items: [{name: 'Milk 1L', qty: 2}], total: 2000, date: new Date().toISOString() }
            ];
            
            const pendingContainer = document.getElementById('pendingOrders');
            const approvedContainer = document.getElementById('approvedOrders');
            
            document.getElementById('pendingOrderCount').textContent = pendingOrders.length;
            
            // Display pending orders
            pendingContainer.innerHTML = '';
            pendingOrders.forEach(order => {
                const orderDiv = document.createElement('div');
                orderDiv.className = 'order-item';
                orderDiv.innerHTML = `
                    <div style="display: flex; justify-content: space-between; align-items: start;">
                        <div>
                            <strong>${order.id}</strong>
                            <div>Customer: ${order.customer}</div>
                            <div>${order.items.map(item => `${item.name} √ó ${item.qty}`).join(', ')}</div>
                            <div><strong>Total: ${order.total} RWF</strong></div>
                        </div>
                        <div style="display: flex; gap: 0.5rem;">
                            <button class="btn btn-small" onclick="approveOrder('${order.id}')">Approve</button>
                            <button class="btn btn-small btn-reject" onclick="rejectOrder('${order.id}')">Reject</button>
                        </div>
                    </div>
                `;
                pendingContainer.appendChild(orderDiv);
            });
            
            // Display approved orders (empty for demo)
            approvedContainer.innerHTML = '<p>No approved orders yet</p>';
        }
function loadDemoSellerOrders() {
    // Use demo buyer products (the same ones shown in buyer side)
    const demoOrders = [
        {
            id: 'ORD-703',
            customer: 'Aline Market',
            items: [{ name: 'Coca Cola 500ml', qty: 5 }],
            total: 3000,
            date: new Date().toISOString()
        },
        {
            id: 'ORD-533',
            customer: 'Urban Buyer',
            items: [{ name: 'Chips', qty: 3 }],
            total: 2400,
            date: new Date().toISOString()
        },
        {
            id: 'ORD-608',
            customer: 'Rural Shop',
            items: [{ name: 'Bottled Water', qty: 2 }],
            total: 600,
            date: new Date().toISOString()
        }
    ];

    localStorage.setItem('sellerOrders', JSON.stringify({ pending: demoOrders, approved: [] }));

    const { pending, approved } = JSON.parse(localStorage.getItem('sellerOrders'));

    const pendingContainer = document.getElementById('pendingOrders');
    const approvedContainer = document.getElementById('approvedOrders');
    document.getElementById('pendingOrderCount').textContent = pending.length;

    // Display pending orders (Coca Cola, Chips, Bottled Water)
    pendingContainer.innerHTML = '';
    pending.forEach(order => {
        const div = document.createElement('div');
        div.className = 'order-item';
        div.innerHTML = `
            <div style="display:flex;justify-content:space-between;align-items:start;">
                <div>
                    <strong>${order.id}</strong><br>
                    Customer: ${order.customer}<br>
                    ${order.items.map(i => `${i.name} √ó ${i.qty}`).join('<br>')}<br>
                    <strong>Total: ${order.total} RWF</strong>
                </div>
                <div style="display:flex;gap:0.5rem;">
                    <button class="btn btn-small" onclick="approveDemoOrder('${order.id}')">Approve</button>
                    <button class="btn btn-small btn-reject" onclick="rejectDemoOrder('${order.id}')">Reject</button>
                </div>
            </div>`;
        pendingContainer.appendChild(div);
    });

    // Display approved orders
    approvedContainer.innerHTML = approved.length
        ? approved.map(order => `
            <div class="order-item">
                <div style="display:flex;justify-content:space-between;align-items:start;">
                    <div>
                        <strong>${order.id}</strong><br>
                        Customer: ${order.customer}<br>
                        ${order.items.map(i => `${i.name} √ó ${i.qty}`).join('<br>')}<br>
                        <strong>Total: ${order.total} RWF</strong>
                    </div>
                    <button class="btn btn-small" onclick="showInvoice(${JSON.stringify(order).replace(/"/g, '&quot;')})">View Invoice</button>
                </div>
            </div>
        `).join('')
        : '<p>No approved orders yet</p>';
}

function approveDemoOrder(orderId) {
    const data = JSON.parse(localStorage.getItem('sellerOrders'));
    const order = data.pending.find(o => o.id === orderId);
    if (!order) return;

    // Update inventory stock quantities
    let stockUpdated = false;
    let removedProducts = [];
    
    order.items.forEach(orderItem => {
        // Find matching product in inventory
        const productIndex = inventory.findIndex(p => p.name === orderItem.name);
        
        if (productIndex !== -1) {
            const product = inventory[productIndex];
            
            // Reduce quantity
            product.quantity -= orderItem.qty;
            stockUpdated = true;
            
            // Check if product is now out of stock
            if (product.quantity <= 0) {
                removedProducts.push(product.name);
                inventory.splice(productIndex, 1);
            }
        }
    });
    
    // Save updated inventory
    if (stockUpdated) {
        localStorage.setItem('inventory', JSON.stringify(inventory));
        refreshInventory();
        updateStats();
    }
    
    // Show toast for removed products
    removedProducts.forEach(productName => {
        showToast(`${productName} sold out and removed from inventory`);
    });

    // Move order to approved
    data.pending = data.pending.filter(o => o.id !== orderId);
    data.approved.push(order);
    localStorage.setItem('sellerOrders', JSON.stringify(data));

    // Generate invoice
    const invoice = {
        id: 'INV-' + order.id,
        date: new Date().toISOString(),
        items: order.items,
        subtotal: order.total,
        tax: order.total * 0.18,
        total: order.total * 1.18
    };

    // Add invoice to buyer's invoices
    const buyerInvoices = JSON.parse(localStorage.getItem('invoices')) || [];
    buyerInvoices.push(invoice);
    localStorage.setItem('invoices', JSON.stringify(buyerInvoices));

    // Refresh display to show approved order with invoice
    loadDemoSellerOrders();
    
    // Show invoice modal
    showInvoice(invoice);
    
    showToast(`Order ${orderId} approved and invoice generated`);
}





function rejectDemoOrder(orderId) {
    const data = JSON.parse(localStorage.getItem('sellerOrders'));
    data.pending = data.pending.filter(o => o.id !== orderId);
    localStorage.setItem('sellerOrders', JSON.stringify(data));
    showToast(`Order ${orderId} rejected`, 'error');
    loadDemoSellerOrders();
}
        function approveOrder(orderId) {
            showToast(`Order ${orderId} approved`);
            loadOrders(); // Refresh
        }

        function rejectOrder(orderId) {
            showToast(`Order ${orderId} rejected`, 'error');
            loadOrders(); // Refresh
        }

        // ==================== STOCK PORTAL FUNCTIONS ====================
        function refreshInventory() {
            const table = document.getElementById('inventoryTable');
            const productSelect = document.getElementById('stockOutProduct');
            
            table.innerHTML = '';
            productSelect.innerHTML = '<option value="">-- Choose Product --</option>';
            
            inventory.forEach((product, index) => {
                // Add to table
                const margin = product.sellPrice - product.buyPrice;
                const marginPercent = ((margin / product.buyPrice) * 100).toFixed(1);
                const stockValue = product.quantity * product.buyPrice;
                
                const statusClass = product.quantity === 0 ? 'stock-out' : 
                                  product.quantity < 10 ? 'stock-low' : 'stock-ok';
                const statusText = product.quantity === 0 ? 'Out of Stock' : 
                                  product.quantity < 10 ? 'Low Stock' : 'In Stock';
                
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td><span class="stock-status ${statusClass}"></span> ${statusText}</td>
                    <td>${product.name}</td>
                    <td>${product.category}</td>
                    <td>${product.quantity}</td>
                    <td>${product.buyPrice.toLocaleString()} RWF</td>
                    <td>${product.sellPrice.toLocaleString()} RWF</td>
                    <td>${marginPercent}%</td>
                    <td>${stockValue.toLocaleString()} RWF</td>
                    <td>
                        <button class="btn btn-small" onclick="editProduct(${index})">Edit</button>
                        <button class="btn btn-small btn-reject" onclick="deleteProduct(${index})">Delete</button>
                    </td>
                `;
                table.appendChild(row);
                
                // Add to product select
                const option = document.createElement('option');
                option.value = index;
                option.textContent = `${product.name} (${product.quantity} in stock)`;
                productSelect.appendChild(option);
            });
            
            updateStats();
        }

        function updateStockOutInfo() {
            const select = document.getElementById('stockOutProduct');
            const infoDiv = document.getElementById('stockOutInfo');
            
            if (select.value === '') {
                infoDiv.innerHTML = 'Select a product to see details';
                return;
            }
            
            const product = inventory[select.value];
            const profit = product.sellPrice - product.buyPrice;
            const profitPercent = ((profit / product.buyPrice) * 100).toFixed(1);
            
            infoDiv.innerHTML = `
                <strong>${product.name}</strong><br>
                In Stock: ${product.quantity}<br>
                Buy Price: ${product.buyPrice.toLocaleString()} RWF<br>
                Sell Price: ${product.sellPrice.toLocaleString()} RWF<br>
                Profit: ${profit.toLocaleString()} RWF (${profitPercent}%)
            `;
        }

        function addStockIn() {
            const name = document.getElementById('stockInName').value;
            const category = document.getElementById('stockInCategory').value;
            const quantity = parseInt(document.getElementById('stockInQuantity').value);
            const buyPrice = parseInt(document.getElementById('stockInBuyPrice').value);
            const sellPrice = parseInt(document.getElementById('stockInSellPrice').value);
            const taxType = document.getElementById('stockInTax').value;
            const supplier = document.getElementById('stockInSupplier').value;
            
            if (!name || !quantity || !buyPrice || !sellPrice || !supplier) {
                showToast('Please fill all required fields', 'error');
                return;
            }
            
            if (sellPrice <= buyPrice) {
                showToast('Sell price must be greater than buy price', 'error');
                return;
            }
            
            const newProduct = {
                productId: 'p' + Date.now(),
                name,
                category,
                quantity,
                buyPrice,
                sellPrice,
                taxType,
                supplier
            };
            
            inventory.push(newProduct);
            localStorage.setItem('inventory', JSON.stringify(inventory));
            
            // Clear form
            document.getElementById('stockInName').value = '';
            document.getElementById('stockInQuantity').value = '';
            document.getElementById('stockInBuyPrice').value = '';
            document.getElementById('stockInSellPrice').value = '';
            document.getElementById('stockInSupplier').value = '';
            
            refreshInventory();
            showToast('Product added to inventory');
        }

        function addStockOut() {
            const productIndex = document.getElementById('stockOutProduct').value;
            const quantity = parseInt(document.getElementById('stockOutQuantity').value);
            
            if (productIndex === '' || !quantity) {
                showToast('Please select product and quantity', 'error');
                return;
            }
            
            const product = inventory[productIndex];
            
            if (quantity > product.quantity) {
                showToast(`Only ${product.quantity} items available`, 'error');
                return;
            }
            
            // Update inventory
            product.quantity -= quantity;
            
            // Record sale
            const sale = {
                productId: product.productId,
                name: product.name,
                quantity,
                sellPrice: product.sellPrice,
                total: quantity * product.sellPrice,
                date: new Date().toISOString()
            };
            
            sales.push(sale);
            localStorage.setItem('sales', JSON.stringify(sales));
            
            // üî• NEW FEATURE: Remove zero-quantity items automatically
            if (product.quantity === 0) {
                inventory.splice(productIndex, 1);
                showToast(`${product.name} sold out and removed from inventory`);
            }
            
            localStorage.setItem('inventory', JSON.stringify(inventory));
            
            // Clear form
            document.getElementById('stockOutProduct').value = '';
            document.getElementById('stockOutQuantity').value = '';
            document.getElementById('stockOutInfo').innerHTML = 'Select a product to see details';
            
            refreshInventory();
            updateStats();
            showToast('Sale recorded successfully');
        }

        function editProduct(index) {
            const product = inventory[index];
            // In a real app, you'd show an edit form/modal
            showToast(`Editing ${product.name} - feature coming soon`);
        }

        function deleteProduct(index) {
            const product = inventory[index];
            if (confirm(`Delete ${product.name} from inventory?`)) {
                inventory.splice(index, 1);
                localStorage.setItem('inventory', JSON.stringify(inventory));
                
                refreshInventory();
                showToast('Product deleted');
            }
        }

        function updateStats() {
            const totalProducts = inventory.length;
            const stockValue = inventory.reduce((sum, product) => sum + (product.quantity * product.buyPrice), 0);
            
            // Calculate today's profit (simplified)
            const today = new Date().toDateString();
            const todaySales = sales.filter(sale => new Date(sale.date).toDateString() === today);
            const todayProfit = todaySales.reduce((sum, sale) => {
                const product = inventory.find(p => p.productId === sale.productId);
                return sum + (sale.quantity * (sale.sellPrice - (product?.buyPrice || sale.sellPrice * 0.8)));
            }, 0);
            
            // Calculate monthly profit (simplified)
            const thisMonth = new Date().getMonth();
            const monthlySales = sales.filter(sale => new Date(sale.date).getMonth() === thisMonth);
            const monthlyProfit = monthlySales.reduce((sum, sale) => {
                const product = inventory.find(p => p.productId === sale.productId);
                return sum + (sale.quantity * (sale.sellPrice - (product?.buyPrice || sale.sellPrice * 0.8)));
            }, 0);
            
            document.getElementById('statTotalProducts').textContent = totalProducts;
            document.getElementById('statStockValue').textContent = stockValue.toLocaleString() + ' RWF';
            document.getElementById('statTodayProfit').textContent = todayProfit.toLocaleString() + ' RWF';
            document.getElementById('statMonthProfit').textContent = monthlyProfit.toLocaleString() + ' RWF';
        }

        function generateReport(type) {
            let reportData = '';
            let title = '';
            
            switch(type) {
                case 'daily':
                    title = 'Daily Sales Report';
                    const today = new Date().toDateString();
                    const dailySales = sales.filter(sale => new Date(sale.date).toDateString() === today);
                    reportData = dailySales.map(sale => `
                        <div class="cart-item">
                            <div>${sale.name} √ó ${sale.quantity}</div>
                            <div>${sale.total.toLocaleString()} RWF</div>
                        </div>
                    `).join('');
                    break;
                    
                case 'weekly':
                    title = 'Weekly Sales Report';
                    const weekAgo = new Date(Date.now() - 7 * 24 * 60 * 60 * 1000);
                    const weeklySales = sales.filter(sale => new Date(sale.date) > weekAgo);
                    reportData = weeklySales.map(sale => `
                        <div class="cart-item">
                            <div>${sale.name} √ó ${sale.quantity}</div>
                            <div>${sale.total.toLocaleString()} RWF</div>
                        </div>
                    `).join('');
                    break;
                    
                case 'monthly':
                    title = 'Monthly Sales Report';
                    const thisMonth = new Date().getMonth();
                    const monthlySales = sales.filter(sale => new Date(sale.date).getMonth() === thisMonth);
                    reportData = monthlySales.map(sale => `
                        <div class="cart-item">
                            <div>${sale.name} √ó ${sale.quantity}</div>
                            <div>${sale.total.toLocaleString()} RWF</div>
                        </div>
                    `).join('');
                    break;
            }
            
            const reportContent = document.getElementById('reportContent');
            reportContent.innerHTML = `
                <h4>${title}</h4>
                ${reportData || '<p>No sales data for this period</p>'}
            `;
        }

        function exportReport() {
            showToast('Export feature coming soon');
        }

        // ==================== UTILITY FUNCTIONS ====================
        function showToast(message, type = 'success') {
            const toast = document.createElement('div');
            toast.className = `toast ${type === 'error' ? 'error' : ''}`;
            toast.textContent = message;
            
            document.body.appendChild(toast);
            
            setTimeout(() => {
                toast.remove();
            }, 3000);
        }

        // Initialize app when window loads
        window.onload = init;
    </script>

    <!-- Firebase SDK v10 -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
</body>
</html>
```